<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base table styles */
        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* Button and filter styles */
        .filter-buttons { margin: 20px 0; }
        .filter-buttons button { margin-right: 10px; padding: 5px 10px; }
        .active-filter { background-color: #4CAF50; color: white; }
        .tab-buttons button {
            padding: 10px 20px;
            margin-right: 10px;
            cursor: pointer;
            border: none;
            background: #f0f0f0;
        }
        .tab-buttons .tab-active {
            background: #4CAF50;
            color: white;
        }

        /* Refresh button styles */
        .refresh-button {
            background-color: #4CAF50;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        }
        .refresh-button:hover {
            background-color: #45a049;
        }
        .refresh-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Input and search styles */
        #searchBox {
            padding: 5px;
            width: 200px;
            margin-left: 10px;
        }
        .top-right-container {
            position: fixed;
            top: 10px;
            right: 10px;
            text-align: right;
        }

        /* Stay Limit Monitor specific styles */
        .stay-limit-monitor {
            max-width: 1200px;
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .stay-limit-monitor h3 {
            margin-top: 0;
            color: #333;
        }

        /* Time filter styles */
        .time-filter {
            padding: 5px 15px;
            margin-right: 10px;
            border: 1px solid #4CAF50;
            background: white;
            color: #4CAF50;
            cursor: pointer;
            border-radius: 4px;
        }
        .active-time-filter {
            background: #4CAF50;
            color: white;
        }

        /* Shower management styles */
        .shower-input {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .shower-input input {
            padding: 12px;
            margin-right: 10px;
            width: 200px;
        }
        .shower-queue {
            margin: 20px;
        }
        .status-waiting { background-color: #fff9c4; }
        .status-in-shower { background-color: #c8e6c9; }
        .status-cleaning { background-color: #ffcdd2; }
        .status-ready { background-color: #bbdefb; }

        .shower-status {
            max-width: 1200px;
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .warning-time {
            background-color: #fff9c4;
            color: #ff6f00;
            font-weight: bold;
        }

        /* Dynamic shower tables */
        .shower-status-container {
            position: absolute;
            top: 100px;
            right: 350px;
            width: 600px;
        }

        .shower-status {
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .shower-status table td, 
        .shower-status table th {
            padding: 12px;
            font-size: 14px;
        }

        .shower-status table {
            width: 100%;
            table-layout: fixed;
        }

        /* Shower table column widths */
        .shower-status table th:nth-child(1) { width: 15%; }
        .shower-status table th:nth-child(2) { width: 15%; }
        .shower-status table th:nth-child(3) { width: 30%; }
        .shower-status table th:nth-child(4) { width: 20%; }
        .shower-status table th:nth-child(5) { width: 20%; }

        .shower-status h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        /* Shower UI elements */
        .next-pax-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0 5px;
        }

        .pax-name {
            font-weight: bold;
            color: #2196F3;
        }

        .shower-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .assign-button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
        }

        .assign-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .assign-button[disabled]:hover::after {
            content: "Shower already in use";
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 10px;
        }

        /* Analytics section */
        .analytics-section {
            margin: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: white;
            clear: both;
            margin-top: 20px;
            height: 800px;
            width: 1220px;
        }

        .charts-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .chart-row {
            display: flex;
            gap: 20px;
        }

        .chart-box {
            flex: 1;
            min-width: 0;
        }

        /* Chart specific styles */
        .access-method-chart,
        .hourly-distribution-chart {
            height: 350px;
            width: 100%;
        }

        #accessChart,
        #hourlyChart,
        #airlineChart {
            max-height: 300px !important;
            width: 100% !important;
        }

        /* Stay time table */
        .stay-time-table {
            width: 300px;
            margin: 20px auto;
            background: white;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .stay-time-table th, 
        .stay-time-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .stay-time-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }

        /* Comparison Styles */
/* Comparison table specific styles */
.comparison-container {
    margin: 20px;
    padding: 15px;
    width: 600px;
    position: absolute;
    right: 250px;
    top: 400px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    z-index: 1000;
}

#comparisonTable {
    width: 100%;
    margin-top: 15px;
    border-collapse: collapse;
}

#comparisonTable th, 
#comparisonTable td {
    padding: 8px;
    text-align: left;
    border: 1px solid #ddd;
}

#comparisonTable th {
    background-color: #f2f2f2;
    font-weight: bold;
}

.match-status-matched {
    color: #4CAF50;
    font-weight: bold;
}

.match-status-unmatched {
    color: #f44336;
    font-weight: bold;
}

.comparison-match {
    background-color: #e8f5e9 !important;
}

.comparison-mismatch {
    background-color: #ffebee !important;
}

/* Status styling */
#comparisonTable td:last-child {
    font-weight: bold;
}

.comparison-match td:last-child {
    color: #4CAF50;
}

.comparison-mismatch td:last-child {
    color: #f44336;
}

/* Even row styling (keeping the zebra pattern) */
#comparisonTable tr:nth-child(even) {
    background-color: #f9f9f9;
}
/* clear button styling  */
.clear-button {
    background-color: #4CAF50;
    color: white;
    padding: 5px 10px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.clear-button:hover {
    background-color: #45a049;
}

/* COMPARISON STYLES */

.comparison-summary {
    padding: 15px;
}

.summary-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.summary-stats {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
}

.stat-box {
    flex: 1;
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.stat-box h4 {
    margin: 0 0 10px 0;
    color: #333;
}

.comparison-status {
    margin: 15px 0;
    padding: 15px;
    border-radius: 8px;
}

.status-ok {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.status-mismatch {
    background-color: #fff3e0;
    color: #e65100;
}

.toggle-details-btn {
    width: 100%;
    padding: 8px;
    background: #f0f0f0;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 10px;
}

.toggle-details-btn:hover {
    background: #e0e0e0;
}

/* Animation for details toggle */
.comparison-details {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.comparison-details.expanded {
    max-height: 500px;
    overflow-y: auto;
}

#mismatch-summary {
    margin-top: 10px;
    padding: 10px;
    border-radius: 4px;
    background: rgba(0,0,0,0.05);
}

    </style>
</head>
<body>
    <!-- Clock and Flight Refresh Button -->
    <div class="top-right-container">
        <div id="clock" style="font-size: 20px;"></div>
        <button id="refreshFlights" onclick="handleRefreshFlights()" class="refresh-button">
            Refresh All Flights
        </button>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-buttons" style="margin-bottom: 20px;">
        <button onclick="showTab('main')" class="tab-active">Main Dashboard</button>
        <button onclick="showTab('inflybo')">Inflybo Data</button>
        <button onclick="showTab('shower')">Shower</button>
        <button onclick="showTab('getaway')" class="tab-buttons">Lounge Getaway</button>
    </div>

    <!-- Main Dashboard Tab -->
    <div id="mainTab" class="tab-content">
        <h2>Main Dashboard</h2>
        
        <!-- Stay Limit Monitor with Refresh Button -->
        <div class="stay-limit-monitor">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <h3>Stay Limit Monitor</h3>
                <button onclick="refreshAllTables()" class="refresh-button">Refresh Tables</button>
            </div>
            <div class="time-filter-buttons" style="margin-bottom: 15px;">
                <button onclick="updateStayLimitMonitor(60)" class="time-filter active-time-filter">1 Hour</button>
                <button onclick="updateStayLimitMonitor(120)" class="time-filter">2 Hours</button>
                <button onclick="updateStayLimitMonitor(180)" class="time-filter">3 Hours</button>
                <button onclick="updateStayLimitMonitor(240)" class="time-filter">4 Hours</button>
            </div>
            <table id="stayLimitTable">
                <thead>
                    <tr>
                        <th style="width: 18%">Name</th>
                        <th style="width: 12%">Access</th>
                        <th style="width: 10%">Flight Code</th>
                        <th style="width: 8%">Guests</th>
                        <th style="width: 8%">Exit Time</th>
                        <th style="width: 8%">Flight Time</th>
                        <th style="width: 12%">Flight Status</th>
                        <th style="width: 12%">Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

        <!-- Shower Status Container (moved outside stay-limit-monitor) -->
        <div class="shower-status-container">
            <div class="shower-status">
                <h3>Shower Status</h3>
                <div id="showerStatusRegular">
                    <table id="showerStatusTable">
                        <thead>
                            <tr>
                                <th>Shower</th>
                                <th>Status</th>
                                <th>PAX Name</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="normalShowerStatus">
                                <td>Normal</td>
                                <td>Empty</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                            <tr id="handicapShowerStatus">
                                <td>Handicap</td>
                                <td>Empty</td>
                                <td>-</td>
                                <td>-</td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="nextPaxAssignment" style="display: none;">
                    <div class="next-pax-header">
                        <h4>Assign Next PAX</h4>
                        <button onclick="returnToShowerStatus()" class="close-button">×</button>
                    </div>
                    <div class="next-pax-content">
                        <p>Next PAX in Queue: <span id="nextPaxName" class="pax-name"></span></p>
                        <div class="shower-options">
                            <button id="assignNormalBtn" onclick="assignToShower('normal')" class="assign-button">
                                Assign to Normal Shower
                            </button>
                            <button id="assignHandicapBtn" onclick="assignToShower('handicap')" class="assign-button">
                                Assign to Handicap Shower
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

            <!-- CHARTS -->
        <div class="analytics-section">
            <div class="charts-container">
                <!-- First row -->
                <div class="chart-row">
                     <div class="chart-box">
                        <h3>Access Method Distribution</h3>
                        <canvas id="accessChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Hourly Distribution</h3>
                        <canvas id="hourlyChart"></canvas>
                    </div>
                </div>
                <!-- Second row -->
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Airline Occupancy</h3>
                        <canvas id="airlineChart"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Average Stay Time</h3>
                        <table class="stay-time-table">
                            <thead>
                                <tr>
                                    <th>Airline</th>
                                    <th>Avg. Stay</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- This will be filled dynamically -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
            
        <!-- inflybo vs lunge getaway comprasion -->
        <div class="comparison-container">
            <!-- Summary View -->
            <div class="comparison-summary">
                <div class="summary-header">
                    <h3>Data Comparison</h3>
                    <button onclick="compareData()" class="refresh-button">Compare Data</button>
                </div>
                
                <div class="summary-stats">
                    <div class="stat-box inflybo-stats">
                        <h4>Inflybo</h4>
                        <div>Priority Pass: <span id="inflybo-pp-count">0</span></div>
                        <div>Lounge Key: <span id="inflybo-lk-count">0</span></div>
                        <div>Total: <span id="inflybo-total">0</span></div>
                    </div>
                    <div class="stat-box getaway-stats">
                        <h4>Lounge Getaway</h4>
                        <div>Priority Pass: <span id="getaway-pp-count">0</span></div>
                        <div>Lounge Key: <span id="getaway-lk-count">0</span></div>
                        <div>Total: <span id="getaway-total">0</span></div>
                    </div>
                </div>
        
                <div id="comparison-status" class="comparison-status">
                    <div id="status-message"></div>
                    <div id="mismatch-summary" style="display: none;"></div>
                </div>
        
                <button onclick="toggleDetailView()" class="toggle-details-btn">
                    Show Details
                </button>
            </div>
        
            <!-- Detailed View (Hidden by default) -->
            <div id="comparison-details" class="comparison-details" style="display: none;">
                <h4>Detailed Comparison</h4>
                <table id="comparisonTable">
                    <thead>
                        <tr>
                            <th>Getaway Name</th>
                            <th>Inflybo Name</th>
                            <th>Time Difference</th>
                            <th>Access Match</th>
                            <th>Guests Match</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>   
    <!-- Inflybo Data Tab -->
    <div id="inflyboTab" class="tab-content" style="display: none;">
        <h1>Paste Inflybo Data</h1>

        <div style="margin-bottom: 10px;">
            <label for="staffInitials">Staff Initials:</label>
            <input type="text" id="staffInitials" maxlength="5" required style="margin-left: 10px;">
        </div>

        <textarea id="inflyboData" rows="10" cols="50"></textarea>
        <br>
        <button onclick="processData()">Process Data</button>
        <button onclick="clearData()">Clear Data</button>
        <button onclick="clearTable()" class="clear-button">Clear Table</button>        
        <div style="margin: 20px 0;">
            <label for="searchBox">Search PAX:</label>
            <input type="text" id="searchBox" onkeyup="searchPAX()" placeholder="Search by name...">
        </div>

        <div class="filter-buttons">
            <button onclick="filterTable('all')" class="active-filter">All</button>
            <button onclick="filterTable('Priority Pass')">Priority Pass</button>
            <button onclick="filterTable('Lounge Key')">Lounge Key</button>
            <button onclick="filterTable('Elite+')">Elite+</button>
            <button onclick="filterTable('Business SkyTeam')">Business SkyTeam</button>
            <button onclick="filterTable('PP+LK')">Priority Pass + Lounge Key</button>
        </div>

        <div id="results">
            <table id="dataTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>Name</th>
                        <th>Access</th>
                        <th>Flight</th>
                        <th>Guests</th>
                        <th>Entry Date</th>
                        <th>Entry Time</th>
                        <th>Exit Time</th>
                        <th>Flight Time</th>
                        <th>Status</th>
                        <th>PAX STATUS</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="getawayTab" class="tab-content" style="display: none;">
        <h1>Paste Lounge Getaway Data</h1>
      
        <textarea id="getawayData" rows="10" cols="50"></textarea>
        <br>
        <button onclick="processGetawayData()">Process Data</button>
        <button onclick="clearGetawayData()">Clear Data</button>
        <button onclick="clearGetawayTable()">Clear Table</button>
        
        <div style="margin: 20px 0;">
            <label for="searchBoxGetaway">Search PAX:</label>
            <input type="text" id="searchBoxGetaway" onkeyup="searchGetawayPAX()" placeholder="Search by name...">
        </div>
    
        <div class="filter-buttons">
            <button onclick="filterGetawayTable('all')" class="active-filter">All</button>
            <button onclick="filterGetawayTable('Priority Pass')">Priority Pass</button>
            <button onclick="filterGetawayTable('LoungeKey')">Lounge Key</button>
        </div>
    
        <div id="getawayResults">
            <table id="getawayTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Staff</th>
                        <th>Name</th>
                        <th>Access</th>
                        <th>Guests</th>
                        <th>Entry Date</th>
                        <th>Entry Time</th>
                        <th>Card Number</th>
                        <th>Visit Reference</th>
                        <th>Capture Method</th>
                        <th>Match Status</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Shower Management Tab -->
    <div id="showerTab" class="tab-content" style="display: none;">
        <h2>Shower Management</h2>
        
        <!-- Input form -->
        <div class="shower-input">
            <input type="text" id="showerPaxName" placeholder="Enter PAX name">
            <button onclick="addToShowerQueue(false)">Add to Queue</button>
            <button onclick="addToShowerQueue(true)">Add as Priority</button>
        </div>

        <!-- Queue display -->
        <div class="shower-queue">
            <h3>Current Queue</h3>
            <table id="showerQueueTable">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Status</th>
                        <th>Time in Status</th>
                        <th>Priority</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // Global variables
        let lastRefreshTime = 0;
        const REFRESH_COOLDOWN = 300000; // 5 minutes in milliseconds
        const DEPARTURE_STATUSES = ['SALIDO', 'ULTIMA LLAMADA', 'PUERTA CERRADA'];
        const CHECKOUT_STATUSES = ['SALIDO', 'EMBARQUE', 'ULTIMA LLAMADA', 'PUERTA CERRADA'];
        let paxStatusMap = new Map(); // Store PAX statuses
        let showerQueue = []; // Array to store shower queue data
        let activeAlerts = [];

        // Clock functions
        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString();
        }

        setInterval(updateClock, 1000);
        updateClock();

        // Tab management
        function showTab(tabName) {
            const tabs = document.getElementsByClassName('tab-content');
            for (let tab of tabs) {
                tab.style.display = 'none';
            }
            document.getElementById(tabName + 'Tab').style.display = 'block';
            
            const buttons = document.getElementsByClassName('tab-buttons')[0].getElementsByTagName('button');
            for (let button of buttons) {
                button.classList.remove('tab-active');
            }
            event.target.classList.add('tab-active');

            // Update tables when switching to main dashboard
            if (tabName === 'main') {
                updateStayLimitMonitor();
                updateShowerDashboard();
              
            }
            updateShowerQueue(); // Update shower queue display when switching tabs
        }


        // Shower Management Functions
        function addToShowerQueue(isPriority) {
            const nameInput = document.getElementById('showerPaxName');
            const name = nameInput.value.trim();
            
            if (!name) {
                alert('Please enter PAX name');
                return;
            }

            const newPax = {
                id: Date.now(), // Unique identifier
                name: name,
                status: 'Waiting',
                startTime: new Date(),
                isPriority: isPriority,
                timeInStatus: 0
            };

            if (isPriority) {
                // Add after last priority PAX or at start
                const lastPriorityIndex = showerQueue.findLastIndex(pax => pax.isPriority);
                if (lastPriorityIndex >= 0) {
                    showerQueue.splice(lastPriorityIndex + 1, 0, newPax);
                } else {
                    showerQueue.unshift(newPax);
                }
            } else {
                showerQueue.push(newPax);
            }

            nameInput.value = '';
            updateShowerQueue();
        }

        function updateShowerStatus(id, newStatus) {
            const pax = showerQueue.find(p => p.id === id);
            if (pax) {
                if (newStatus.includes('Shower')) {
                    // Check if shower is available
                    const showerType = newStatus.includes('Normal') ? 'Normal' : 'Handicap';
                    const inUse = showerQueue.some(p => 
                        p.id !== id && 
                        p.status.includes(showerType)
                    );
                    if (inUse) {
                        alert(`${showerType} shower is currently in use`);
                        return;
                    }
                    // Start timer only when putting PAX in shower
                    pax.startTime = new Date();
                }
                pax.status = newStatus;
                pax.timeInStatus = 0;
                updateShowerQueue();
                updateShowerDashboard();
            }
        }

        function updateShowerDashboard() {
            const normalShower = showerQueue.find(p => p.status === 'In Normal Shower' || p.status === 'Normal Cleaning');
            const handicapShower = showerQueue.find(p => p.status === 'In Handicap Shower' || p.status === 'Handicap Cleaning');
            const now = new Date();

            // Update Normal Shower
            const normalRow = document.getElementById('normalShowerStatus');
            if (normalShower) {
                const timeInShower = Math.floor((now - normalShower.startTime) / 60000);
                const isCleaning = normalShower.status === 'Normal Cleaning';
                
                normalRow.innerHTML = `
                    <td>Normal</td>
                    <td>${isCleaning ? 'Cleaning' : 'In Use'}</td>
                    <td>${truncateName(normalShower.name)}</td>
                    <td class="${timeInShower >= 20 && !isCleaning ? 'warning-time' : ''}">${timeInShower} min</td>
                    <td>${isCleaning ? 
                        '<button onclick="markShowerReady(\'normal\')">Ready</button>' : 
                        '<button onclick="finishShower(\'normal\', ' + normalShower.id + ')">Finished</button>'}</td>
                `;
                normalRow.className = isCleaning ? 'status-cleaning' : '';
            } else {
                normalRow.innerHTML = `
                    <td>Normal</td>
                    <td>Empty</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                `;
                normalRow.className = '';
            }

            // Update Handicap Shower (similar logic)
            const handicapRow = document.getElementById('handicapShowerStatus');
            if (handicapShower) {
                const timeInShower = Math.floor((now - handicapShower.startTime) / 60000);
                const isCleaning = handicapShower.status === 'Handicap Cleaning';
                
                handicapRow.innerHTML = `
                    <td>Handicap</td>
                    <td>${isCleaning ? 'Cleaning' : 'In Use'}</td>
                     <td>${truncateName(handicapShower.name)}</td>
                    <td class="${timeInShower >= 20 && !isCleaning ? 'warning-time' : ''}">${timeInShower} min</td>
                    <td>${isCleaning ? 
                        '<button onclick="markShowerReady(\'handicap\')">Ready</button>' : 
                        '<button onclick="finishShower(\'handicap\', ' + handicapShower.id + ')">Finished</button>'}</td>
                `;
                handicapRow.className = isCleaning ? 'status-cleaning' : '';
            } else {
                handicapRow.innerHTML = `
                    <td>Handicap</td>
                    <td>Empty</td>
                    <td>-</td>
                    <td>-</td>
                    <td>-</td>
                `;
                handicapRow.className = '';
            }
        }

        function finishShower(showerType, paxId) {
            const pax = showerQueue.find(p => p.id === paxId);
            if (pax) {
                pax.status = `${showerType.charAt(0).toUpperCase() + showerType.slice(1)} Cleaning`;
                pax.startTime = new Date(); // Reset timer for cleaning status
                updateShowerQueue();
                updateShowerDashboard();
            }
        }

        function markShowerReady(showerType) {
            // Get next PAX in queue
            const nextPax = showerQueue.find(p => p.status === 'Waiting');
            
            if (nextPax) {
                // Show assignment options
                document.getElementById('showerStatusRegular').style.display = 'none';
                document.getElementById('nextPaxAssignment').style.display = 'block';
                document.getElementById('nextPaxName').textContent = nextPax.name;
                
                // Only consider showers as occupied if they are actively in use
                const normalInUse = showerQueue.some(p => p.status === 'In Normal Shower');
                const handicapInUse = showerQueue.some(p => p.status === 'In Handicap Shower');
                
                document.getElementById('assignNormalBtn').disabled = normalInUse;
                document.getElementById('assignHandicapBtn').disabled = handicapInUse;
            } else {
                // If no PAX in queue, just remove the cleaning PAX
                const currentPax = showerQueue.find(p => 
                    p.status === `${showerType.charAt(0).toUpperCase() + showerType.slice(1)} Cleaning`
                );
                if (currentPax) {
                    showerQueue = showerQueue.filter(p => p.id !== currentPax.id);
                }
                updateShowerQueue();
                updateShowerDashboard();
            }
        }


        function assignToShower(showerType) {
            const nextPax = showerQueue.find(p => p.status === 'Waiting');
            if (nextPax) {
                // Remove any PAX that was in cleaning status for this shower
                const cleaningPax = showerQueue.find(p => 
                    p.status === `${showerType.charAt(0).toUpperCase() + showerType.slice(1)} Cleaning`
                );
                if (cleaningPax) {
                    showerQueue = showerQueue.filter(p => p.id !== cleaningPax.id);
                }

                // Assign the next PAX to the shower
                nextPax.status = `In ${showerType.charAt(0).toUpperCase() + showerType.slice(1)} Shower`;
                nextPax.startTime = new Date();
            }
            
            // Return to normal view
            document.getElementById('showerStatusRegular').style.display = 'block';
            document.getElementById('nextPaxAssignment').style.display = 'none';
            
            updateShowerQueue();
            updateShowerDashboard();
        }

        function returnToShowerStatus() {
            document.getElementById('showerStatusRegular').style.display = 'block';
            document.getElementById('nextPaxAssignment').style.display = 'none';
        }

        function removePaxFromQueue(id) {
            showerQueue = showerQueue.filter(p => p.id !== id);
            updateShowerQueue();
        }

        function updateShowerQueue() {
            const table = document.getElementById('showerQueueTable').getElementsByTagName('tbody')[0];
            const now = new Date();
            
            // Update display
            table.innerHTML = '';
            showerQueue.forEach(pax => {
                const timeInStatus = Math.floor((now - pax.startTime) / 60000); // minutes
                pax.timeInStatus = timeInStatus;

                const tr = document.createElement('tr');
                tr.className = `status-${pax.status.toLowerCase().replace(' ', '-')}`;
                
                let actionButtons = '';
                switch(pax.status) {
                    case 'Waiting':
                        actionButtons = `
                            <button onclick="updateShowerStatus(${pax.id}, 'In Normal Shower')">Use Normal</button>
                            <button onclick="updateShowerStatus(${pax.id}, 'In Handicap Shower')">Use Handicap</button>
                        `;
                        break;
                    case 'In Normal Shower':
                    case 'In Handicap Shower':
                        actionButtons = `
                            <button onclick="updateShowerStatus(${pax.id}, 'Cleaning')">Finished</button>
                        `;
                        break;
                    case 'Cleaning':
                        actionButtons = `
                            <button onclick="updateShowerStatus(${pax.id}, 'Ready')">Ready</button>
                        `;
                        break;
                    case 'Ready':
                        actionButtons = `
                            <button onclick="removePaxFromQueue(${pax.id})">Remove</button>
                        `;
                        break;
                }

                tr.innerHTML = `
                    <td>${truncateName(pax.name)}</td>
                    <td>${pax.status}</td>
                    <td>${timeInStatus} min ${timeInStatus >= 20 && pax.status.includes('Shower') ? '⚠️' : ''}</td>
                    <td>${pax.isPriority ? 'Yes' : 'No'}</td>
                    <td>${actionButtons}</td>
                `;
                table.appendChild(tr);
            });
        }

        function truncateName(name, maxLength = 15) { // Adjust maxLength as needed
            if (name.length <= maxLength) return name;
            return name.substring(0, maxLength - 3) + '...';
        }

        // Set up periodic updates for shower queue times
        setInterval(() => {
            updateShowerQueue();
            updateShowerDashboard();
        }, 60000); // Update both shower queue and dashboard every minute

        // Stay Limit Monitor functions
        function updateStayLimitMonitor(timeLimit = 60) {
            // Update filter button styles
            const filterButtons = document.querySelectorAll('.time-filter');
            filterButtons.forEach(btn => btn.classList.remove('active-time-filter'));
            event?.target?.classList.add('active-time-filter');

            const mainTable = document.querySelector('#dataTable tbody');
            const monitorTable = document.querySelector('#stayLimitTable tbody');
            
            if (!mainTable || !monitorTable) return;
            
            // Show loading state
            monitorTable.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 20px;">
                        Loading...
                    </td>
                </tr>
            `;
            
            setTimeout(() => {
                monitorTable.innerHTML = '';
                const currentTime = new Date();
                const currentHour = currentTime.getHours();
                const currentMinute = currentTime.getMinutes();
                
                const rows = Array.from(mainTable.rows);
                let paxToShow = [];
                
                rows.forEach(row => {
                    // Skip if PAX has a status (CHECK OUT or CALLED)
                    const paxStatus = row.cells[10] ? row.cells[10].textContent.trim() : '';
                    if (paxStatus === 'CHECK OUT' || paxStatus === 'CALLED') {
                        return;
                    }

                    const exitTimeStr = row.cells[7].textContent.trim();
                    const [exitHour, exitMinute] = exitTimeStr.split(':').map(Number);
                    
                    let minutesUntilExit = (exitHour - currentHour) * 60 + (exitMinute - currentMinute);
                    if (minutesUntilExit < 0) {
                        minutesUntilExit += 24 * 60;
                    }
                    
                    if (minutesUntilExit <= timeLimit) {
                        paxToShow.push({
                            name: row.cells[1].textContent,
                            access: row.cells[2].textContent,
                            flightCode: row.cells[3].textContent,
                            guests: row.cells[4].textContent,
                            exitTime: exitTimeStr,
                            flightTime: row.cells[8].textContent,
                            flightStatus: row.cells[9].textContent,
                            paxStatus: paxStatus,
                            minutesUntilExit: minutesUntilExit
                        });
                    }
                });
                
                // Sort by urgency (minutes until exit)
                paxToShow.sort((a, b) => a.minutesUntilExit - b.minutesUntilExit);
                // Limit to 10 entries no matter what time filter is selected
                paxToShow = paxToShow.slice(0, 10);
                
                // If no PAX to show, display message
                if (paxToShow.length === 0) {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td colspan="8" style="text-align: center; padding: 20px;">
                            No PAX to call at this time
                        </td>
                    `;
                    monitorTable.appendChild(tr);
                    return;
                }
                
                // Add rows to monitor table
                paxToShow.forEach(pax => {
                    const tr = document.createElement('tr');
                    
                    // Add color based on urgency
                    if (pax.minutesUntilExit <= 15) {
                        tr.style.backgroundColor = '#ffcdd2'; // Red
                    } else if (pax.minutesUntilExit <= 30) {
                        tr.style.backgroundColor = '#fff9c4'; // Yellow
                    }
                    
                    tr.innerHTML = `
                        <td>${pax.name}</td>
                        <td>${pax.access}</td>
                        <td>${pax.flightCode}</td>
                        <td>${pax.guests}</td>
                        <td>${pax.exitTime}</td>
                        <td>${pax.flightTime}</td>
                        <td>${pax.flightStatus || ''}</td>
                        <td>
                            <button onclick="updatePaxStatus('${pax.name}', 'CHECK OUT')" class="action-button checkout-btn">Check Out</button>
                            <button onclick="updatePaxStatus('${pax.name}', 'CALLED')" class="action-button called-btn">Called</button>
                        </td>
                    `;
                    monitorTable.appendChild(tr);
                });
            }, 500);
        }

function updatePaxStatus(paxName, status) {
    // Update the PAX status in the Inflybo data table
    const dataTable = document.querySelector('#dataTable tbody');
    if (dataTable) {
        const rows = Array.from(dataTable.rows);
        const paxRow = rows.find(row => row.cells[1].textContent.trim() === paxName);
        
        if (paxRow) {
            // If the PAX STATUS column doesn't exist yet (10 columns is the original count)
            if (paxRow.cells.length === 10) {
                const statusCell = paxRow.insertCell();
                statusCell.textContent = status;
            } else {
                // Update existing PAX STATUS cell
                paxRow.cells[10].textContent = status;
            }

            // If status is CHECK OUT and row has background color, clear it
            if (status === 'CHECK OUT') {
                paxRow.style.backgroundColor = '';
            }
        }
    }
    
    // Refresh the stay limit monitor to reflect changes
    updateStayLimitMonitor();
}
// Add this function to automatically check flight statuses and update PAX STATUS
function checkFlightStatuses() {
    const CHECKOUT_STATUSES = ['SALIDO', 'ULTIMA LLAMADA', 'PUERTA CERRADA', 'EMBARQUE'];
    const tbody = document.querySelector('#dataTable tbody');
    if (!tbody) return;
    
    Array.from(tbody.rows).forEach(row => {
        const flightStatus = row.cells[9].textContent.trim();
        // Check if the status is in our CHECKOUT_STATUSES array and the PAX STATUS is empty
        if (CHECKOUT_STATUSES.includes(flightStatus)) {
            // Always ensure the cell exists first
            if (row.cells.length === 10) {
                const statusCell = row.insertCell();
                statusCell.textContent = 'CHECK OUT';
            } else if (!row.cells[10].textContent || row.cells[10].textContent === 'Loading...') {
                row.cells[10].textContent = 'CHECK OUT';
            }
        }
    });
}
        // Flight status refresh function
        function refreshAllFlightStatuses() {
    const tbody = document.querySelector('#dataTable tbody');
    if (!tbody) return Promise.resolve();

    const rows = tbody.getElementsByTagName('tr');
    
    // First set all to Loading...
    for (let i = 0; i < rows.length; i++) {
        rows[i].cells[8].textContent = 'Loading...';
        rows[i].cells[9].textContent = 'Loading...';
    }
    
    // Create an array of promises for all flight status updates
    const updatePromises = Array.from(rows).map(row => {
        const flightCell = row.cells[3];
        const flightCode = flightCell.textContent;
        
        return fetch(`/api/flight-time/${formatFlightCode(flightCode)}`)
            .then(response => response.json())
            .then(flightData => {
                row.cells[8].textContent = flightData.time || 'Not found';
                row.cells[9].textContent = flightData.status || '';
            })
            .catch(error => {
                row.cells[8].textContent = 'Error';
                row.cells[9].textContent = '';
            });
    });

    // Return the promise chain
    return Promise.all(updatePromises)
        .then(() => {
            checkFlightStatuses();
            updateStayLimitMonitor();
        });
}

        // [Rest of your existing functions: searchPAX, filterTable, clearData, clearTable, etc.]

                // Search and filter functions
                function searchPAX() {
            const searchText = document.getElementById('searchBox').value.toLowerCase();
            const tbody = document.querySelector('#dataTable tbody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const nameCell = row.cells[1].textContent.toLowerCase();
                row.style.display = nameCell.includes(searchText) ? '' : 'none';
            }
        }
 
        function filterTable(category) {
            const tbody = document.querySelector('#dataTable tbody');
            const rows = tbody.getElementsByTagName('tr');
            const buttons = document.querySelectorAll('.filter-buttons button');
            
            buttons.forEach(btn => btn.classList.remove('active-filter'));
            event.target.classList.add('active-filter');
            
            for (let row of rows) {
                const accessCell = row.cells[2].textContent;
                if (category === 'all') {
                    row.style.display = '';
                } else if (category === 'PP+LK') {
                    row.style.display = (accessCell === 'Priority Pass' || accessCell === 'Lounge Key') ? '' : 'none';
                } else {
                    row.style.display = accessCell === category ? '' : 'none';
                }
            }
        }
 
        // Data management functions
        function clearData() {
            document.getElementById('inflyboData').value = '';
            document.getElementById('staffInitials').value = '';
        }
 
        function clearTable() {
            if (confirm('Are you sure you want to clear the table? This action cannot be undone.')) {
                const tbody = document.querySelector('#dataTable tbody');
                tbody.innerHTML = '';
                document.getElementById('dataTable').style.display = 'none';
                if (accessChart) {
                    accessChart.destroy();
                }
            }
        }
 
        function formatFlightCode(code) {
            const airline = code.slice(0, 2);
            const number = parseInt(code.slice(2)).toString();
            return `${airline} ${number}`;
        }
 
        function processData() {
    const initials = document.getElementById('staffInitials').value.trim();
    if (!initials) {
        alert('Please enter receptionist initials');
        return;
    }

    const data = document.getElementById('inflyboData').value;

    fetch('/api/process-inflybo', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ data: data })
    })
    .then(response => response.json())
    .then(data => {
        const table = document.getElementById('dataTable');
        const tbody = table.getElementsByTagName('tbody')[0];
        
        // Check existing entries to avoid duplicates
        const existingEntries = new Set(Array.from(tbody.rows).map(row => {
            return `${row.cells[1].textContent}-${row.cells[6].textContent}`; // name + entry time as unique identifier
        }));
        
        // Filter out duplicates from new data
        const newData = data.filter(row => {
            const entryId = `${row.name}-${row.entry.time}`;
            return !existingEntries.has(entryId);
        });

        // Sort new entries by date/time
        newData.sort((a, b) => {
            const dateA = new Date(a.entry.day + ' ' + a.entry.time);
            const dateB = new Date(b.entry.day + ' ' + b.entry.time);
            return dateA - dateB;
        });
        
        // Create array to store all flight status fetch promises
        const fetchPromises = [];
        
        // Add only new entries
        newData.forEach((row, index) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${initials}</td>
                <td>${row.name}</td>
                <td>${row.access}</td>
                <td>${row.airline_flight}</td>
                <td>${row.guests}</td>
                <td>${row.entry.day}</td>
                <td>${row.entry.time}</td>
                <td>${row.entry.exit_time}</td>
                <td id="flight-${row.airline_flight}-${index}">Loading...</td>
                <td id="status-${row.airline_flight}-${index}">Loading...</td>
                <td></td>  <!-- PAX STATUS column -->
            `;
            tbody.appendChild(tr);

            // Add each fetch promise to our array
            const fetchPromise = fetch(`/api/flight-time/${formatFlightCode(row.airline_flight)}`)
                .then(response => response.json())
                .then(flightData => {
                    document.getElementById(`flight-${row.airline_flight}-${index}`).textContent = 
                        flightData.time || 'Not found';
                    document.getElementById(`status-${row.airline_flight}-${index}`).textContent = 
                        flightData.status || '';
                })
                .catch(error => {
                    document.getElementById(`flight-${row.airline_flight}-${index}`).textContent = 'Error';
                    document.getElementById(`status-${row.airline_flight}-${index}`).textContent = '';
                });
            
            fetchPromises.push(fetchPromise);
        });

        table.style.display = 'table';
        
        // Wait for all flight status fetches to complete before updating everything
        Promise.all(fetchPromises)
            .then(() => {
                checkFlightStatuses();  // Now this will work with complete flight status data
                updateAccessChart();
                updateStayLimitMonitor();
                updateShowerDashboard();
            });
    });
}

        function handleRefreshFlights() {
    const currentTime = Date.now();
    const refreshButton = document.getElementById('refreshFlights');
    
    // Check if enough time has passed since last refresh
    if (currentTime - lastRefreshTime < REFRESH_COOLDOWN) {
        const remainingTime = Math.ceil((REFRESH_COOLDOWN - (currentTime - lastRefreshTime)) / 60000);
        alert(`Please wait ${remainingTime} minutes before refreshing again`);
        return;
    }

    // Disable the button and show loading state
    refreshButton.disabled = true;
    refreshButton.textContent = 'Refreshing...';

    // Call the refresh function
    refreshAllFlightStatuses()
        .then(() => {
            // Update last refresh time
            lastRefreshTime = Date.now();
            
            // Re-enable the button after refresh
            setTimeout(() => {
                refreshButton.disabled = false;
                refreshButton.textContent = 'Refresh All Flights';
            }, 2000);
        })
        .catch(error => {
            console.error('Error refreshing flights:', error);
            refreshButton.disabled = false;
            refreshButton.textContent = 'Refresh All Flights';
            alert('Error refreshing flights. Please try again.');
        });
}

// Lounge Getaway Functions
function processGetawayData() {
    const data = document.getElementById('getawayData').value;
    const lines = data.trim().split('\n');
    const tbody = document.querySelector('#getawayTable tbody');
    const table = document.getElementById('getawayTable');

    // Clear existing data
    tbody.innerHTML = '';

    lines.forEach(line => {
        if (line.includes('Valid records =')) return; // Skip summary line
        
        const columns = line.split('\t');
        if (columns.length < 7) return; // Skip invalid lines

        const [dateTime, cardNumber, visitRef, name, guests, captureMethod, program] = columns;
        
        // Split datetime into date and time
        const [date, time] = dateTime.split(' ');
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>EP</td>  <!-- Default value -->
            <td>${name.trim()}</td>
            <td>${program.trim()}</td>
            <td>${guests.trim()}</td>
            <td>${date}</td>
            <td>${time}</td>
            <td>${cardNumber.trim()}</td>
            <td>${visitRef.trim()}</td>
            <td>${captureMethod.trim()}</td>
            <td class="match-status">Pending</td>
        `;
        tbody.appendChild(tr);
    });

    table.style.display = 'table';
}

function cleanName(name) {
    // Remove titles and common suffixes
    const titles = ['mr', 'ms', 'mrs', 'miss', 'dr', 'sr', 'jr'];
    let cleaned = name.toLowerCase();
    titles.forEach(title => {
        cleaned = cleaned.replace(new RegExp(`\\b${title}\\b`), '');
    });
    
    // Remove special characters and extra spaces
    cleaned = cleaned.replace(/[^\w\s]/g, ' ').replace(/\s+/g, ' ').trim();
    return cleaned;
}

function parseInflyboName(name) {
    // Handle lastname/firstname format
    let [lastName, firstName] = name.split('/').map(part => cleanName(part));
    
    // If no slash found, try space separation
    if (!firstName) {
        [firstName, lastName] = name.split(' ').map(part => cleanName(part));
    }
    
    return {
        firstName: firstName || '',
        lastName: lastName || '',
        full: cleanName(name)
    };
}

function parseGetawayName(name) {
    const parts = cleanName(name).split(' ').filter(p => p);
    let firstName = parts[0] || '';
    let lastName = parts[1] || '';
    let additional = parts.slice(2).join(' '); // Keep additional names
    
    return {
        firstName,
        lastName,
        additional,
        full: cleanName(name)
    };
}

function getSimilarity(inflyboName, getawayName) {
    // Parse both names
    const inflybo = parseInflyboName(inflyboName);
    const getaway = parseGetawayName(getawayName);
    
    let score = 0;
    let reasons = [];

    // Compare first names (including partial matches and initials)
    if (inflybo.firstName && getaway.firstName) {
        if (inflybo.firstName === getaway.firstName) {
            score += 0.4;
            reasons.push('First name exact match');
        } else if (inflybo.firstName.includes(getaway.firstName) || 
                   getaway.firstName.includes(inflybo.firstName)) {
            score += 0.3;
            reasons.push('First name partial match');
        } else if (inflybo.firstName[0] === getaway.firstName[0]) {
            score += 0.1;
            reasons.push('First initial match');
        }
    }

    // Compare last names
    if (inflybo.lastName && getaway.lastName) {
        if (inflybo.lastName === getaway.lastName) {
            score += 0.6;
            reasons.push('Last name exact match');
        } else if (inflybo.lastName.includes(getaway.lastName) || 
                   getaway.lastName.includes(inflybo.lastName)) {
            score += 0.4;
            reasons.push('Last name partial match');
        }
    }

    // Look for parts of one name in the other's full name
    const inflyboFull = inflybo.full;
    const getawayFull = getaway.full;
    
    if (inflyboFull.includes(getawayFull) || getawayFull.includes(inflyboFull)) {
        score += 0.2;
        reasons.push('Full name contained in other');
    }

    // Additional checks for initials in additional names
    if (getaway.additional) {
        const additionalInitials = getaway.additional.split(' ').map(word => word[0]);
        const inflyboWords = inflyboFull.split(' ');
        
        additionalInitials.forEach(initial => {
            if (inflyboWords.some(word => word.startsWith(initial))) {
                score += 0.1;
                reasons.push('Additional initial match');
            }
        });
    }

    return {
        score: Math.min(score, 1), // Cap at 1.0
        reasons,
        debug: {
            inflybo,
            getaway
        }
    };
}

function compareData() {
    const TIME_WINDOW = 7;
    const NAME_SIMILARITY_THRESHOLD = 0.7;
    
    const getawayRows = Array.from(document.querySelector('#getawayTable tbody').rows);
    const inflyboRows = Array.from(document.querySelector('#dataTable tbody').rows);
    const comparisonTbody = document.querySelector('#comparisonTable tbody');
    comparisonTbody.innerHTML = '';

    let matches = [];
    let mismatches = [];

    getawayRows.forEach(getawayRow => {
        const getawayTime = getawayRow.cells[5].textContent.trim();
        const [getawayHour, getawayMinute] = getawayTime.split(':').map(Number);
        const getawayTotalMinutes = getawayHour * 60 + getawayMinute;
        const getawayGuests = parseInt(getawayRow.cells[3].textContent) || 0;
        const getawayAccess = getawayRow.cells[2].textContent.trim().toLowerCase().replace(/\s+/g, '');
        const getawayName = getawayRow.cells[1].textContent.trim();

        let bestMatch = null;
        let minTimeDiff = Infinity;
        let matchType = '';
        let bestMatchReasons = [];

        // First pass: Try to find match within time window
        inflyboRows.forEach(inflyboRow => {
            const inflyboTime = inflyboRow.cells[6].textContent.trim();
            const [inflyboHour, inflyboMinute] = inflyboTime.split(':').map(Number);
            const inflyboTotalMinutes = inflyboHour * 60 + inflyboMinute;
            const timeDiff = Math.abs(getawayTotalMinutes - inflyboTotalMinutes);
            const inflyboGuests = parseInt(inflyboRow.cells[4].textContent) || 0;
            const inflyboAccess = inflyboRow.cells[2].textContent.trim().toLowerCase().replace(/\s+/g, '');

            if (timeDiff <= TIME_WINDOW && 
                getawayAccess === inflyboAccess &&
                getawayGuests === inflyboGuests) {
                if (timeDiff < minTimeDiff) {
                    minTimeDiff = timeDiff;
                    bestMatch = inflyboRow;
                    matchType = 'time';
                    bestMatchReasons = ['Time window match'];
                }
            }
        });

        // Second pass: If no match found, look for name similarity
        if (!bestMatch) {
            let bestSimilarityScore = 0;
            
            inflyboRows.forEach(inflyboRow => {
                const inflyboName = inflyboRow.cells[1].textContent.trim();
                const inflyboAccess = inflyboRow.cells[2].textContent.trim().toLowerCase().replace(/\s+/g, '');
                const inflyboGuests = parseInt(inflyboRow.cells[4].textContent) || 0;
                
                // Only compare if access type and guests match
                if (getawayAccess === inflyboAccess && getawayGuests === inflyboGuests) {
                    const similarity = getSimilarity(inflyboName, getawayName);
                    
                    if (similarity.score > NAME_SIMILARITY_THRESHOLD && 
                        similarity.score > bestSimilarityScore) {
                        bestSimilarityScore = similarity.score;
                        bestMatch = inflyboRow;
                        matchType = 'name';
                        bestMatchReasons = similarity.reasons;
                        
                        // Calculate time difference for display
                        const inflyboTime = inflyboRow.cells[6].textContent.trim();
                        const [inflyboHour, inflyboMinute] = inflyboTime.split(':').map(Number);
                        const inflyboTotalMinutes = inflyboHour * 60 + inflyboMinute;
                        minTimeDiff = Math.abs(getawayTotalMinutes - inflyboTotalMinutes);
                    }
                }
            });
        }

        // Update match status in Getaway table
        getawayRow.cells[9].textContent = bestMatch ? 'Matched' : 'Unmatched';
        getawayRow.cells[9].className = bestMatch ? 'match-status-matched' : 'match-status-unmatched';

        // Create comparison table row
        const tr = document.createElement('tr');
        tr.className = bestMatch ? 'comparison-match' : 'comparison-mismatch';
        
        tr.innerHTML = `
            <td>${getawayRow.cells[1].textContent}</td>
            <td>${bestMatch ? bestMatch.cells[1].textContent : 'No match found'}</td>
            <td>${bestMatch ? 
                minTimeDiff + ' minutes' + 
                (matchType === 'name' ? ' (name match: ' + bestMatchReasons.join(', ') + ')' : '') 
                : 'N/A'}</td>
            <td>${bestMatch ? 'Yes' : 'N/A'}</td>
            <td>${bestMatch ? 'Yes' : 'N/A'}</td>
            <td>${bestMatch ? 'Matched' : 'Unmatched'}</td>
        `;
        
        comparisonTbody.appendChild(tr);

        // Add to matches or mismatches array for summary
        if (bestMatch) {
            matches.push({
                getaway: getawayName,
                inflybo: bestMatch.cells[1].textContent.trim(),
                matchType: matchType
            });
        } else {
            mismatches.push({
                name: getawayName,
                source: 'Lounge Getaway',
                missing: 'Inflybo'
            });
        }
    });

    // Check for entries in Inflybo that aren't in Getaway
    inflyboRows.forEach(inflyboRow => {
        const inflyboName = inflyboRow.cells[1].textContent.trim();
        if (!matches.some(match => match.inflybo === inflyboName)) {
            mismatches.push({
                name: inflyboName,
                source: 'Inflybo',
                missing: 'Lounge Getaway'
            });
        }
    });

    // Update the summary view
    updateComparisonSummary(matches, mismatches);
}

function clearGetawayData() {
    document.getElementById('getawayData').value = '';
    document.getElementById('staffInitialsGetaway').value = '';
}

function clearGetawayTable() {
    const tbody = document.querySelector('#getawayTable tbody');
    tbody.innerHTML = '';
    document.getElementById('getawayTable').style.display = 'none';
    document.getElementById('comparisonResults').style.display = 'none';
}

function searchGetawayPAX() {
    const searchText = document.getElementById('searchBoxGetaway').value.toLowerCase();
    const tbody = document.querySelector('#getawayTable tbody');
    const rows = tbody.getElementsByTagName('tr');
    
    for (let row of rows) {
        const nameCell = row.cells[1].textContent.toLowerCase();
        row.style.display = nameCell.includes(searchText) ? '' : 'none';
    }
}

function filterGetawayTable(category) {
    const tbody = document.querySelector('#getawayTable tbody');
    const rows = tbody.getElementsByTagName('tr');
    const buttons = document.querySelectorAll('.filter-buttons button');
    
    buttons.forEach(btn => btn.classList.remove('active-filter'));
    event.target.classList.add('active-filter');
    
    for (let row of rows) {
        const accessCell = row.cells[2].textContent;
        if (category === 'all') {
            row.style.display = '';
        } else {
            row.style.display = accessCell === category ? '' : 'none';
        }
    }
}

function toggleDetailView() {
    const details = document.getElementById('comparison-details');
    const button = document.querySelector('.toggle-details-btn');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        button.textContent = 'Hide Details';
        details.classList.add('expanded');
    } else {
        details.style.display = 'none';
        button.textContent = 'Show Details';
        details.classList.remove('expanded');
    }
}

function updateComparisonSummary(matches, mismatches) {
    // Get counts from both tables
    const inflyboRows = Array.from(document.querySelector('#dataTable tbody').rows);
    const getawayRows = Array.from(document.querySelector('#getawayTable tbody').rows);
    
    // Calculate totals including guests - FIXED to use correct data for each system
    const inflyboCounts = {
        pp: inflyboRows.reduce((sum, row) => {
            if (row.cells[2].textContent.trim() === 'Priority Pass') {
                return sum + 1 + (parseInt(row.cells[4].textContent) || 0);
            }
            return sum;
        }, 0),
        lk: inflyboRows.reduce((sum, row) => {
            if (row.cells[2].textContent.trim() === 'Lounge Key') {
                return sum + 1 + (parseInt(row.cells[4].textContent) || 0);
            }
            return sum;
        }, 0)
    };
    
    const getawayCounts = {
        pp: getawayRows.reduce((sum, row) => {
            if (row.cells[2].textContent.trim() === 'Priority Pass') {
                return sum + 1 + (parseInt(row.cells[3].textContent) || 0);
            }
            return sum;
        }, 0),
        lk: getawayRows.reduce((sum, row) => {
            if (row.cells[2].textContent.trim() === 'LoungeKey') {
                return sum + 1 + (parseInt(row.cells[3].textContent) || 0);
            }
            return sum;
        }, 0)
    };

    // Update count displays
    document.getElementById('inflybo-pp-count').textContent = inflyboCounts.pp;
    document.getElementById('inflybo-lk-count').textContent = inflyboCounts.lk;
    document.getElementById('inflybo-total').textContent = inflyboCounts.pp + inflyboCounts.lk;
    
    document.getElementById('getaway-pp-count').textContent = getawayCounts.pp;
    document.getElementById('getaway-lk-count').textContent = getawayCounts.lk;
    document.getElementById('getaway-total').textContent = getawayCounts.pp + getawayCounts.lk;

    // Get last entry information
    const lastGetawayRow = getawayRows[getawayRows.length - 1];
    const lastTime = lastGetawayRow ? lastGetawayRow.cells[5].textContent.trim() : new Date().toLocaleTimeString();
    const lastInitials = document.getElementById('staffInitials').value.trim() || 'EP';

    const statusDiv = document.getElementById('comparison-status');
    const statusMessage = document.getElementById('status-message');
    const mismatchSummary = document.getElementById('mismatch-summary');

    // Check for actual mismatches in detail view
    const detailRows = Array.from(document.querySelector('#comparisonTable tbody').rows);
    const unmatchedRows = detailRows.filter(row => row.classList.contains('comparison-mismatch'));
    
    if (unmatchedRows.length === 0) {
        // All entries matched
        statusDiv.className = 'comparison-status status-ok';
        statusMessage.textContent = `CHECK OK AT ${lastTime} by ${lastInitials}`;
        mismatchSummary.style.display = 'none';
    } else {
        // There are mismatches
        statusDiv.className = 'comparison-status status-mismatch';
        statusMessage.textContent = `Found ${unmatchedRows.length} mismatches`;
        mismatchSummary.style.display = 'block';
        mismatchSummary.innerHTML = 'Click "Show Details" below for more information';
    }
}



        // Set up regular updates for stay limit monitor
        setInterval(updateStayLimitMonitor, 60000);  // Update every minute


        
        
    </script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/alerts.js') }}"></script>
 </body>
 </html> 